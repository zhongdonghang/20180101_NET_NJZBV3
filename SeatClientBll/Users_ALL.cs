using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using SeatManage.ClassModel;
using System.ServiceModel;

namespace SeatManage.Bll
{
    public class Users_ALL
    {
        /// <summary>
        /// 添加新的用户
        /// </summary>
        /// <param name="user"></param>
        /// <returns></returns>
        public static bool AddNewUser(UserInfo user)
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.AddNewUser(user);
            }
            catch (Exception ex)
            {
                error = true;
                SeatManageComm.WriteLog.Write("添加用户失败：" + ex.Message);
                return false;
            }
            finally
            {
                if (!error)
                {
                    (seatService as IDisposable).Dispose();
                }
            }
        }
        /// <summary>
        /// 获取全部用户
        /// </summary>
        /// <returns></returns>
        public static List<UserInfo> GetUsers()
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.GetUsers();
            }
            catch (Exception EX)
            {
                error = true;
                SeatManageComm.WriteLog.Write("获取用户信息失败：" + EX.Message);
                return new List<UserInfo>();
            }
            finally
            {
                if (!error)
                {
                    (seatService as IDisposable).Dispose();
                }
            }
        }
        /// <summary>
        /// 获取用户信息
        /// </summary>
        /// <param name="LoginId"></param>
        /// <returns></returns>
        public static UserInfo GetUserInfo(string LoginId)
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.GetUserInfo(LoginId);
            }
            catch (Exception EX)
            {
                error = true;
                SeatManageComm.WriteLog.Write("获取用户信息失败：" + EX.Message);
                return null;
            }
            finally
            {
                if (!error)
                {
                    (seatService as IDisposable).Dispose();
                }
            }
        }
        /// <summary>
        /// 更新读者信息
        /// </summary>
        /// <param name="user"></param>
        /// <returns></returns>
        public static bool UpdateUserInfo(UserInfo user)
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.UpdateUserInfo(user);
            }
            catch (Exception ex)
            {
                error = true;
                SeatManageComm.WriteLog.Write("更新读者信息失败：" + ex.Message);
                return false;
            }
            finally
            {
                if (!error)
                {
                    (seatService as IDisposable).Dispose();
                }
            }
        }
        /// <summary>
        /// 删除用户
        /// </summary>
        /// <param name="user"></param>
        /// <returns></returns>
        public static bool DeleteUser(UserInfo user)
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.DeleteUser(user);
            }
            catch (Exception ex)
            {
                error = true;
                SeatManageComm.WriteLog.Write("删除读者信息失败：" + ex.Message);
                return false;
            }
            finally
            {
                if (!error)
                {
                    (seatService as IDisposable).Dispose();
                }
            }
        }
        /// <summary>
        /// 验证用户登录
        /// </summary>
        /// <param name="loginId">用户名</param>
        /// <param name="passWord">密码</param>
        /// <returns>返回null为登录失败</returns>
        public string CheckUser(string loginId, string passWord)
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.CheckUser(loginId, passWord);
            }
            catch (Exception ex)
            {
                error = true;
                SeatManageComm.WriteLog.Write("密码验证失败：" + ex.Message);
                throw ex;
            }
            finally
            {
                ICommunicationObject ICommObjectService = seatService as ICommunicationObject;
                try
                {
                    if (ICommObjectService.State == CommunicationState.Faulted)
                    {
                        ICommObjectService.Abort();
                    }
                    else
                    {
                        ICommObjectService.Close();
                    }
                }
                catch
                {
                    ICommObjectService.Abort();
                }
            }
        }
        
        public static List<int> GetRoleID(string loginId)
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.GetRoleID(loginId);
            }
            catch (Exception ex)
            {
                error = true;
                SeatManageComm.WriteLog.Write("获取角色失败：" + ex.Message);
                return new List<int>();
            }
            finally
            {
                ICommunicationObject ICommObjectService = seatService as ICommunicationObject;
                try
                {
                    if (ICommObjectService.State == CommunicationState.Faulted)
                    {
                        ICommObjectService.Abort();
                    }
                    else
                    {
                        ICommObjectService.Close();
                    }
                }
                catch
                {
                    ICommObjectService.Abort();
                }
            }
        }
        /// <summary>
        /// 简单更新，更新密码用户名等，不更新权限
        /// </summary>
        /// <param name="user"></param>
        /// <returns></returns>
        public static bool UpdateUserOnlyInfo(UserInfo user)
        {
            IWCFService.ISeatManageService seatService = WcfAccessProxy.ServiceProxy.CreateChannelSeatManageService();
            bool error = false;
            try
            {
                return seatService.UpdateUser(user);
            }
            catch (Exception ex)
            {
                error = true;
                SeatManageComm.WriteLog.Write("更新读者信息失败：" + ex.Message);
                return false;
            }
            finally
            {
                ICommunicationObject ICommObjectService = seatService as ICommunicationObject;
                try
                {
                    if (ICommObjectService.State == CommunicationState.Faulted)
                    {
                        ICommObjectService.Abort();
                    }
                    else
                    {
                        ICommObjectService.Close();
                    }
                }
                catch
                {
                    ICommObjectService.Abort();
                }
            }
        }
    }
}
